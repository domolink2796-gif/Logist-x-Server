<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Logist Master HQ | v86.5</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background: #010409; color: #e6edf3; font-family: 'Inter', sans-serif; margin: 0; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(13, 17, 23, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.05); border-radius: 2rem; }
        .btn-gold { background: linear-gradient(135deg, #f59e0b, #b45309); color: #000; font-weight: 900; }
        .btn-gold:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        .btn-dark { background: #21262d; border: 1px solid #30363d; color: #8b949e; }
        input { background: #000 !important; border: 1px solid #30363d !important; color: #fff !important; border-radius: 12px !important; padding: 14px !important; width: 100%; outline: none; }
        input:focus { border-color: #f59e0b !important; }
        .card-active { border-left: 4px solid #f59e0b; }
        /* Анимация загрузки для кнопки */
        .loader { width: 18px; height: 18px; border: 2px solid #000; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [isAuth, setIsAuth] = useState(false);
            const [pass, setPass] = useState("");
            const [keys, setKeys] = useState([]);
            const [loading, setLoading] = useState(false);

            const login = () => pass.toLowerCase() === 'евгений никитин' ? (setIsAuth(true), refresh()) : alert("Отказ");
            
            const refresh = async () => {
                setLoading(true);
                try {
                    const res = await fetch('/api/list_keys');
                    const data = await res.json();
                    setKeys(data.keys || []);
                } catch(e) { console.error("Ошибка загрузки:", e); }
                setLoading(false);
            };

            const addKey = async (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                setLoading(true);
                
                try {
                    const response = await fetch('/api/add_key', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            name: fd.get('o'), 
                            days: fd.get('d'), 
                            limit: fd.get('l') 
                        })
                    });

                    if (response.ok) {
                        // Ждем 3 секунды, чтобы Google Drive успел всё обработать
                        await new Promise(r => setTimeout(r, 3000));
                        await refresh();
                        e.target.reset();
                    } else {
                        alert("Ошибка при создании ключа на сервере");
                    }
                } catch(err) {
                    console.error("Ошибка запроса:", err);
                    alert("Сервер не отвечает");
                } finally {
                    setLoading(false);
                }
            };

            const updateKey = async (key, days, limit) => {
                setLoading(true);
                await fetch('/api/update_key', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ key, addDays: days, addLimit: limit })
                });
                await new Promise(r => setTimeout(r, 1000));
                refresh();
            };

            const deleteKey = async (key) => {
                if(!confirm('Удалить лицензию полностью?')) return;
                await fetch('/api/delete_key', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ key })
                });
                refresh();
            };

            const getDaysLeft = (expiry) => {
                const diff = new Date(expiry) - new Date();
                return Math.max(0, Math.ceil(diff / (1000 * 60 * 60 * 24)));
            };

            if (!isAuth) return (
                <div className="h-screen flex items-center justify-center p-6 bg-[#010409]">
                    <div className="glass p-10 w-full max-w-sm text-center border-amber-500/20 shadow-2xl animate__animated animate__fadeIn">
                        <h1 className="text-4xl font-black mb-10 text-amber-500 italic">LOGIST HQ</h1>
                        <input type="password" value={pass} onChange={e=>setPass(e.target.value)} placeholder="ПАРОЛЬ МАСТЕРА" className="mb-6 text-center tracking-widest font-bold" onKeyDown={e=>e.key==='Enter'&&login()} />
                        <button onClick={login} className="btn-gold w-full py-5 rounded-2xl uppercase font-black tracking-widest active:scale-95 transition-all">ВОЙТИ</button>
                    </div>
                </div>
            );

            return (
                <div className="p-4 md:p-8 max-w-6xl mx-auto min-h-screen">
                    <header className="flex justify-between items-center mb-8 glass p-6 shadow-2xl border-amber-500/10">
                        <div>
                            <h1 className="text-xl font-black italic text-amber-500 tracking-tighter uppercase leading-none">Master Control</h1>
                            <p className="text-[10px] opacity-30 font-bold uppercase tracking-widest mt-1">v86.5 Admin Panel</p>
                        </div>
                        <button onClick={refresh} disabled={loading} className="bg-amber-500 text-black px-6 py-2 rounded-xl text-[10px] font-black uppercase active:scale-90 transition-all flex items-center gap-2">
                            {loading && <span className="loader"></span>}
                            {loading ? "СИНХРОНИЗАЦИЯ..." : "ОБНОВИТЬ СПИСОК"}
                        </button>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2 space-y-4">
                            {keys.length === 0 && !loading && (
                                <div className="text-center py-20 opacity-20 font-black uppercase italic border-2 border-dashed border-white/5 rounded-[2rem]">
                                    Ключей пока нет
                                </div>
                            )}
                            {keys.map(k => {
                                const days = getDaysLeft(k.expiry);
                                return (
                                    <div key={k.key} className={`glass p-6 hover:border-amber-500/30 transition-all ${days > 0 ? 'card-active' : 'border-red-500/50'}`}>
                                        <div className="flex justify-between items-start mb-6">
                                            <div className="bg-amber-500/10 px-4 py-1.5 rounded-full border border-amber-500/20">
                                                <span className="font-mono text-amber-500 font-black text-xs tracking-wider">{k.key}</span>
                                            </div>
                                            <div className="text-right">
                                                <div className={`text-[10px] font-black uppercase ${days < 5 ? 'text-red-500 animate-pulse' : 'text-emerald-500'}`}>
                                                    {days > 0 ? `Осталось: ${days} дн.` : 'Истек'}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="text-2xl font-black uppercase mb-2 tracking-tight">{k.name}</div>
                                        <div className="text-[10px] opacity-30 mb-6 font-bold uppercase tracking-widest italic">
                                            Лимит воркеров: {k.workers ? k.workers.length : 0} / {k.limit}
                                        </div>

                                        <div className="flex flex-wrap gap-2 mb-8">
                                            {k.workers && k.workers.length > 0 ? k.workers.map(w => (
                                                <span key={w} className="bg-white/5 px-3 py-1.5 rounded-xl text-[10px] font-bold border border-white/5">{w}</span>
                                            )) : <span className="text-[10px] opacity-20 italic">Устройства не подключены</span>}
                                        </div>

                                        <div className="grid grid-cols-3 gap-2 border-t border-white/5 pt-6">
                                            <button onClick={() => updateKey(k.key, 7, 0)} className="btn-dark py-3 rounded-xl text-[9px] font-black uppercase active:bg-white/10 transition-colors">+7 Дней</button>
                                            <button onClick={() => updateKey(k.key, 0, 1)} className="btn-dark py-3 rounded-xl text-[9px] font-black uppercase active:bg-white/10 transition-colors">+1 Место</button>
                                            <button onClick={() => deleteKey(k.key)} className="bg-red-500/10 text-red-500 border border-red-500/20 py-3 rounded-xl text-[9px] font-black uppercase">Удалить</button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        <div className="space-y-6">
                            <form onSubmit={addKey} className="glass p-8 sticky top-10 border-amber-500/10 shadow-2xl">
                                <h2 className="text-center font-black uppercase text-[11px] text-amber-500 mb-8 tracking-[4px] italic">Новый Контракт</h2>
                                
                                <div className="space-y-5">
                                    <div>
                                        <label className="text-[9px] uppercase font-black opacity-30 ml-1 mb-2 block">Компания / Заказчик</label>
                                        <input name="o" placeholder="Напр: ТАНДЕР" required className="font-bold uppercase" disabled={loading} />
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-[9px] uppercase font-black opacity-30 ml-1 mb-2 block">Срок (дней)</label>
                                            <input name="d" type="number" defaultValue="30" className="font-bold text-center" disabled={loading} />
                                        </div>
                                        <div>
                                            <label className="text-[9px] uppercase font-black opacity-30 ml-1 mb-2 block">Места (чел)</label>
                                            <input name="l" type="number" defaultValue="1" className="font-bold text-center" disabled={loading} />
                                        </div>
                                    </div>

                                    <button type="submit" disabled={loading} className="btn-gold w-full py-5 rounded-2xl uppercase font-black text-[11px] tracking-widest shadow-2xl active:scale-95 transition-all flex justify-center items-center gap-3">
                                        {loading ? <span className="loader"></span> : "Выпустить ключ"}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
    </script>
</body>
</html>
