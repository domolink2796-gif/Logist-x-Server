const express = require('express');
const { google } = require('googleapis');
const bodyParser = require('body-parser');
const cors = require('cors');
const { Readable } = require('stream');
const path = require('path');

const app = express();
app.use(cors());
app.use(bodyParser.json({ limit: '50mb' }));

// --- НАСТРОЙКИ ---
const MASTER_KEY = "LX-BOSS-777"; 
const MY_ROOT_ID = '1Q0NHwF4xhODJXAT0U7HUWMNNXhdNGf2A';
const DB_NAME = 'DATABASE_KEYS_LOGIST_X';

const CLIENT_ID = '355201275272-14gol1u31gr3qlan5236v241jbe13r0a.apps.googleusercontent.com';
const CLIENT_SECRET = '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';
const REFRESH_TOKEN = '1//04Xx4TeSGvK3OCgYIARAAGAQSNwF-L9Irgd6A14PB5ziFVjs-PftE7jdGY0KoRJnXeVlDuD1eU2ws6Kc1gdlmSYz99MlOQvSeLZ0';

const oauth2Client = new google.auth.OAuth2(CLIENT_ID, CLIENT_SECRET, 'https://developers.google.com/oauthplayground');
oauth2Client.setCredentials({ refresh_token: REFRESH_TOKEN });
const drive = google.drive({ version: 'v3', auth: oauth2Client });
const sheets = google.sheets({ version: 'v4', auth: oauth2Client });

// Поиск ID таблицы базы ключей
async function getDbId() {
    const res = await drive.files.list({ q: `name = '${DB_NAME}' and trashed = false` });
    return res.data.files.length > 0 ? res.data.files[0].id : null;
}

// --- API ДЛЯ ПАНЕЛИ УПРАВЛЕНИЯ ---
app.get('/api/list_keys', async (req, res) => {
    try {
        const ssId = await getDbId();
        if (!ssId) return res.json({ keys: [] });
        const resData = await sheets.spreadsheets.values.get({ spreadsheetId: ssId, range: 'Sheet1!A2:E100' });
        const keys = (resData.data.values || []).map(r => ({
            key: r[0], name: r[1], expiry: r[2], limit: r[3], workers: r[4] ? r[4].split(',') : []
        }));
        res.json({ keys });
    } catch (e) { res.status(500).json({ error: e.message }); }
});

app.post('/api/add_key', async (req, res) => {
    try {
        const { name, days, limit } = req.body;
        const newKey = "LX-" + Math.random().toString(36).substr(2, 9).toUpperCase();
        const expiryDate = new Date();
        expiryDate.setDate(expiryDate.getDate() + parseInt(days));
        
        const ssId = await getDbId();
        await sheets.spreadsheets.values.append({
            spreadsheetId: ssId, range: 'Sheet1!A1', valueInputOption: 'USER_ENTERED',
            resource: { values: [[newKey, name, expiryDate.toISOString(), limit, ""]] }
        });
        res.json({ success: true, key: newKey });
    } catch (e) { res.status(500).json({ error: e.message }); }
});

app.post('/api/delete_key', async (req, res) => {
    try {
        const { key } = req.body;
        const ssId = await getDbId();
        const resData = await sheets.spreadsheets.values.get({ spreadsheetId: ssId, range: 'Sheet1!A:A' });
        const rowIndex = resData.data.values.findIndex(r => r[0] === key);
        if (rowIndex === -1) return res.status(404).send("Not found");

        await sheets.spreadsheets.batchUpdate({
            spreadsheetId: ssId,
            resource: { requests: [{ deleteDimension: { range: { sheetId: 0, dimension: "ROWS", startIndex: rowIndex, endIndex: rowIndex + 1 } } }] }
        });
        res.json({ success: true });
    } catch (e) { res.status(500).json({ error: e.message }); }
});

// Загрузка фото (Логистика X)
app.post('/upload', async (req, res) => {
    try {
        const { worker, city, address, client, image } = req.body;
        const f1 = await getOrCreateFolder("Евгений_БОСС", MY_ROOT_ID);
        const f2 = await getOrCreateFolder(worker || "Монтажник", f1);
        const f3 = await getOrCreateFolder(city || "Город", f2);
        const f4 = await getOrCreateFolder(new Date().toLocaleDateString('ru-RU'), f3);
        const f5 = await getOrCreateFolder(client || "Объект", f4);

        if (image) {
            const buffer = Buffer.from(image, 'base64');
            await drive.files.create({
                resource: { name: `${address}.jpg`, parents: [f5] },
                media: { mimeType: 'image/jpeg', body: Readable.from(buffer) }
            });
        }
        res.json({ success: true });
    } catch (e) { res.status(500).json({ success: false }); }
});

async function getOrCreateFolder(name, parentId) {
    let q = `name = '${name}' and mimeType = 'application/vnd.google-apps.folder' and trashed = false and '${parentId}' in parents`;
    const res = await drive.files.list({ q });
    if (res.data.files.length > 0) return res.data.files[0].id;
    const folder = await drive.files.create({ resource: { name, mimeType: 'application/vnd.google-apps.folder', parents: [parentId] }, fields: 'id' });
    return folder.data.id;
}

app.get('/admin-panel', (req, res) => res.sendFile(path.join(__dirname, 'admin.html')));
app.get('/', (req, res) => res.send("LOGIST-X PRO SYSTEM ACTIVE"));

app.listen(process.env.PORT || 3000, () => console.log("СЕРВЕР И ПАНЕЛЬ ЗАПУЩЕНЫ"));
